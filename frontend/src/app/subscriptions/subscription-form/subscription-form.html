<div class="container">
  <div class="strip"></div>
  <h2 class="mb-4">Gestion des abonnements</h2>

  <!-- BOUTON POUR OUVRIR LA MODALE -->
  <div class="mb-3 text-center">
    <button class="btn btn-primary" (click)="openModal()">Ajouter un abonnement</button>
  </div>

  <!-- MODALE BOOTSTRAP -->
  <div
    class="modal fade"
    tabindex="-1"
    [ngClass]="{ 'show d-block': showModal }"
    [style.backgroundColor]="'rgba(0,0,0,0.5)'"
    role="dialog"
    aria-modal="true"
    [attr.aria-hidden]="!showModal"
  >
    <div class="modal-dialog modal-dialog-centered" role="document" style="max-width: 600px;">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            {{ isEditMode ? 'Modifier un abonnement' : 'Ajouter un abonnement' }}
          </h5>
          <button type="button" class="btn-close" aria-label="Close" (click)="closeModal()"></button>
        </div>

        <form [formGroup]="form" (ngSubmit)="onSubmit()" class="p-3" novalidate>
          <div *ngIf="error" class="alert alert-danger">{{ error }}</div>
          <div *ngIf="success" class="alert alert-success">{{ success }}</div>

          <!-- Nom -->
          <div class="mb-3">
            <label class="form-label">Nom</label>
            <input formControlName="name" class="form-control" />
            <div *ngIf="form.controls['name'].invalid && form.controls['name'].touched" class="text-danger">
              Le nom est obligatoire.
            </div>
          </div>

          <!-- Fournisseur -->
          <div class="mb-3">
            <label class="form-label">Fournisseur</label>
            <select formControlName="provider_id" class="form-select" (change)="onProviderChange()">
              <option [ngValue]="null">-- Choisir un fournisseur --</option>
              <option *ngFor="let p of providers" [ngValue]="p.id">{{ p.nom }}</option>
            </select>
            <div *ngIf="form.controls['provider_id'].invalid && form.controls['provider_id'].touched" class="text-danger">
              Le fournisseur est obligatoire.
            </div>
          </div>

          <!-- AperÃ§u logo -->
          <div class="mb-3" *ngIf="selectedProviderLogo">
            <label class="form-label">Logo du fournisseur :</label><br />
            <img [src]="selectedProviderLogo" alt="Logo fournisseur" class="logo-preview" (error)="hideImage($event)" />
          </div>

          <!-- Montant -->
          <div class="mb-3">
            <label class="form-label">Montant</label>
            <input type="number" formControlName="amount" class="form-control" min="0" />
            <div *ngIf="form.controls['amount'].invalid && form.controls['amount'].touched" class="text-danger">
              Le montant est obligatoire et doit Ãªtre â‰¥ 0.
            </div>
          </div>

          <!-- Cycle -->
          <div class="mb-3">
            <label class="form-label">Cycle de facturation</label>
            <select formControlName="billing_cycle" class="form-select">
              <option value="monthly">Mensuel</option>
              <option value="yearly">Annuel</option>
            </select>
          </div>

          <!-- Notes -->
          <div class="mb-3">
            <label class="form-label">Notes</label>
            <textarea formControlName="notes" class="form-control"></textarea>
          </div>

          <!-- Tags -->
          <div class="mb-3">
            <label class="form-label">Tags (sÃ©parÃ©s par des virgules)</label>
            <input formControlName="tags" class="form-control" />
          </div>

          <!-- Date prochain paiement -->
          <div class="mb-3">
            <label class="form-label">Date du prochain paiement</label>
            <input type="date" formControlName="next_payment_date" class="form-control" />
            <div *ngIf="form.controls['next_payment_date'].invalid && form.controls['next_payment_date'].touched" class="text-danger">
              La date du prochain paiement est obligatoire.
            </div>
          </div>

          <!-- Stripe -->
          <div class="mb-3" *ngIf="clientSecret">
            <label class="form-label">Carte bancaire</label>
            <div #cardElement class="form-control p-2" style="height: 42px;"></div>
            <div id="card-errors" class="text-danger mt-2"></div>
          </div>

          <div class="d-flex justify-content-end">
            <button type="button" class="btn btn-secondary me-2" (click)="closeModal()">Annuler</button>
            <button type="submit" class="btn btn-primary" [disabled]="form.invalid">
              {{ isEditMode ? 'Modifier' : 'Ajouter' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- AGENDA MODERNE -->
  <div class="agenda-section">
    <div class="agenda-header">
      <h3 class="agenda-title">
        <i class="fas fa-calendar-alt"></i>
        Agenda des Abonnements
      </h3>
      <button class="btn btn-toggle-agenda" (click)="toggleAgenda()">
        <i [class]="showAgenda ? 'fas fa-eye-slash' : 'fas fa-eye'"></i>
        <span>{{ showAgenda ? "Masquer" : "Afficher" }}</span>
      </button>
    </div>

    <div *ngIf="showAgenda" class="agenda-container">
      <div class="agenda-stats">
        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-list"></i>
          </div>
          <div class="stat-content">
            <span class="stat-number">{{ subscriptions.length }}</span>
            <span class="stat-label">Abonnements</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon urgent">
            <i class="fas fa-exclamation-triangle"></i>
          </div>
          <div class="stat-content">
            <span class="stat-number">{{ getUpcomingPayments().length }}</span>
            <span class="stat-label">Paiements proches</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon success">
            <i class="fas fa-euro-sign"></i>
          </div>
          <div class="stat-content">
            <span class="stat-number">{{ getTotalMonthlyAmount() | number:'1.2-2' }}</span>
            <span class="stat-label">DT/mois</span>
          </div>
        </div>
      </div>

      <div class="agenda-timeline">
        <div *ngFor="let sub of subscriptions; let i = index"
             class="timeline-item"
             [ngClass]="getTimelineItemClass(sub)">

          <div class="timeline-marker">
            <div class="timeline-dot" [ngClass]="getTimelineDotClass(sub)">
              <i [class]="getTimelineIcon(sub)"></i>
            </div>
            <div class="timeline-line" *ngIf="i < subscriptions.length - 1"></div>
          </div>

          <div class="timeline-content">
            <div class="timeline-card">
              <div class="timeline-header">
                <div class="timeline-logo">
                  <img *ngIf="sub.logo_path"
                       [src]="sub.logo_path"
                       alt="Logo"
                       class="agenda-logo"
                       (error)="hideImage($event)" />
                  <div *ngIf="!sub.logo_path" class="agenda-logo-placeholder">
                    <i class="fas fa-building"></i>
                  </div>
                </div>

                <div class="timeline-info">
                  <h5 class="timeline-title">{{ sub.name }}</h5>
                  <p class="timeline-provider">{{ getProviderName(sub.provider_id) }}</p>
                  <div class="timeline-meta">
                    <span class="timeline-amount">{{ sub.amount }} DT</span>
                    <span class="timeline-cycle" [ngClass]="sub.billing_cycle === 'monthly' ? 'cycle-monthly' : 'cycle-yearly'">
                      {{ sub.billing_cycle === 'monthly' ? 'Mensuel' : 'Annuel' }}
                    </span>
                  </div>
                </div>

                <div class="timeline-date">
                  <div class="date-badge" [ngClass]="getDateBadgeClass(sub)">
                    <div class="date-day">{{ sub.next_payment_date | date: 'dd' }}</div>
                    <div class="date-month">{{ sub.next_payment_date | date: 'MMM' | uppercase }}</div>
                  </div>
                  <div class="date-status" [ngClass]="getDateStatusClass(sub)">
                    {{ getDateStatusText(sub) }}
                  </div>
                </div>
              </div>

              <div class="timeline-actions" *ngIf="isPaymentDue(sub.next_payment_date)">
                <button class="btn btn-pay-now" (click)="renewSubscription(sub)">
                  <i class="fas fa-credit-card"></i>
                  <span>Payer maintenant</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="section-divider"></div>

  <!-- LISTE -->
  <h3 class="text-center mb-4">Liste des abonnements</h3>

  <div class="table-container">
    <table class="table">
      <thead>
        <tr>
          <th>Logo</th>
          <th>Nom</th>
          <th>Fournisseur</th>
          <th>Montant</th>
          <th>Cycle</th>
          <th>Date de crÃ©ation</th>
 <th>
  <label>
    <input type="checkbox" [checked]="allSelected" (change)="toggleSelectAll()" />
    Auto Payment
  </label>
</th>

          <th>Prochain paiement</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let sub of subscriptions">
          <td style="text-align: center;">
            <img *ngIf="sub.logo_path" [src]="sub.logo_path" alt="Logo" class="logo-table" (error)="hideImage($event)" />
          </td>
          <td class="table-cell-primary">{{ sub.name }}</td>
          <td class="table-cell-secondary">{{ getProviderName(sub.provider_id) }}</td>
          <td class="table-cell-primary">{{ sub.amount }} DT</td>
          <td>
            <span class="badge-status" [ngClass]="sub.billing_cycle === 'monthly' ? 'badge-active' : 'badge-pending'">
              {{ sub.billing_cycle === 'monthly' ? 'Mensuel' : 'Annuel' }}
            </span>
          </td>
          <td class="table-cell-secondary">{{ sub.created_at | date: 'dd/MM/yyyy' }}</td>

<!-- Checkbox individuelle dans le *ngFor -->
<td>
  <input type="checkbox"
         [checked]="selectedSubscriptions.includes(sub.id)"
         (change)="toggleSelection(sub)" />
</td>

          <!-- âœ… Cellule rouge si paiement dÃ» -->
          <td [ngClass]="{ 'bg-danger': isPaymentDue(sub.next_payment_date), 'bg-success': !isPaymentDue(sub.next_payment_date) }">
            <ng-container *ngIf="isPaymentDue(sub.next_payment_date); else normalDate">
              ðŸ”´ Paiement en retard
            </ng-container>
            <ng-template #normalDate>
              {{ sub.next_payment_date | date: 'dd/MM/yyyy' }}
            </ng-template>
          </td>

          <!-- Actions -->
          <td class="actions">
            <button class="btn btn-action btn-edit" (click)="editSubscription(sub)" title="Modifier l'abonnement">
              <i class="fas fa-edit"></i>
              <span>Modifier</span>
            </button>

            <button class="btn btn-action btn-delete" (click)="deleteSubscription(sub.id)" title="Supprimer l'abonnement">
              <i class="fas fa-trash"></i>
              <span>Supprimer</span>
            </button>

            <!-- âœ… Bouton spÃ©cial si paiement dÃ» -->
            <button *ngIf="isPaymentDue(sub.next_payment_date)"
                    class="btn btn-action btn-pay"
                    (click)="renewSubscription(sub)"
                    title="Effectuer le paiement">
              <i class="fas fa-credit-card"></i>
              <span>Payer</span>
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <hr />

  <!-- NOTIFICATIONS MODERNES -->
  <div class="notifications-section">
    <h3 class="notifications-title">
      <i class="fas fa-bell"></i>
      Notifications
      <span *ngIf="notifications.length > 0" class="notification-count">{{ notifications.length }}</span>
    </h3>

    <!-- Ã‰tat vide -->
    <div *ngIf="notifications.length === 0" class="empty-notifications">
      <div class="empty-icon">
        <i class="fas fa-bell-slash"></i>
      </div>
      <h4>Aucune notification</h4>
      <p>Vous Ãªtes Ã  jour ! Aucune notification pour le moment.</p>
    </div>

    <!-- Liste des notifications -->
    <div *ngIf="notifications.length > 0" class="notifications-container">
      <div *ngFor="let notif of notifications; let i = index"
           class="notification-card"
           [ngClass]="getNotificationClass(notif)">

        <div class="notification-icon">
          <i [class]="getNotificationIcon(notif)"></i>
        </div>

        <div class="notification-content">
          <div class="notification-header">
            <h5 class="notification-title">{{ notif.title }}</h5>
            <span class="notification-time">{{ notif.date | date: 'dd/MM HH:mm' }}</span>
          </div>
          <p class="notification-body">{{ notif.body }}</p>
          <div class="notification-footer">
            <span class="notification-date">{{ notif.date | date: 'dd/MM/yyyy Ã  HH:mm:ss' }}</span>
          </div>
        </div>

        <button class="notification-close" (click)="removeNotification(i)" title="Supprimer cette notification">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Bouton pour effacer toutes les notifications -->
      <div class="notifications-actions">
        <button class="btn btn-clear-all" (click)="clearNotifications()">
          <i class="fas fa-trash-alt"></i>
          <span>Effacer toutes les notifications</span>
        </button>
      </div>
    </div>
  </div>
</div>
